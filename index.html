<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boat Battery Sizer & Load Calculator</title>
  <style>
    :root{
      --bg:#0b1320; --panel:#121a2b; --muted:#94a3b8; --text:#e6edf3; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#1f2a44;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--text);}
    header{padding:16px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg,rgba(11,19,32,.95),rgba(11,19,32,.85));backdrop-filter:saturate(1.1) blur(6px);z-index:5}
    h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.3px}
    header .sub{font-size:12px;color:var(--muted)}
    main{padding:16px 16px 28px;max-width:1300px;margin:0 auto}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:15px}
    .card .content{padding:14px 16px}

    /* SETTINGS layout: pair side-by-side, note below */
    .row{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .pair{display:flex;gap:10px;align-items:center}
    .pair label{min-width:140px;font-size:12px;color:var(--muted)}
    .pair input,.pair select{flex:1;min-width:0;padding:8px;border-radius:10px;border:1px solid var(--line);background:#0c1626;color:var(--text)}
    input[type="number"]{appearance:textfield}
    input:focus,select:focus{outline:2px solid rgba(96,165,250,.35)}
    .note{font-size:12px;color:var(--muted)}

    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tab{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0c1626;font-size:12px;color:var(--muted);cursor:pointer;user-select:none}
    .tab.active{color:var(--text);background:#132038}
    .tabpanes > .pane{display:none}
    .tabpanes > .pane.active{display:block}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    button{background:#0c1626;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#2b4a7a,#1b2f52);border-color:#223659}
    button:hover{filter:brightness(1.08)}

    table{width:100%;border-collapse:collapse;border:1px solid var(--line);overflow:hidden;border-radius:12px}
    thead th{position:sticky;top:0;background:#0e1a2f;border-bottom:1px solid var(--line);font-weight:600}
    th,td{border-bottom:1px solid var(--line);padding:8px;font-size:12px;text-align:left}
    tbody tr:hover{background:#0d1628}
    .number{width:100px}
    .qty{width:72px}
    .select{min-width:150px}

    #loadTable th:nth-child(2), #loadTable th:nth-child(3), #loadTable th:nth-child(4){min-width:140px}
    #loadTable td:nth-child(2) select, #loadTable td:nth-child(3) select, #loadTable td:nth-child(4) select{min-width:140px}

    .center{text-align:center}

    .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:900px){.summary{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#0c1626;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .label{font-size:11px;color:var(--muted)}
    .kpi .value{font-size:18px;margin-top:4px}
    .kpi.ok .value{color:var(--ok)}
    .kpi.warn .value{color:var(--warn)}
    .kpi.bad .value{color:var(--bad)}

    .foot{margin-top:14px;font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0c1626;font-size:11px;margin-right:6px}

    /* Generation form */
    .gen-form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px}
    .gen-form .full{grid-column:1 / -1}
    .gen-list table td.actions{white-space:nowrap}
    .badge{display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:999px;font-size:11px;background:#0c1626;color:var(--muted)}
    .muted{color:var(--muted);font-size:12px}
    .danger{color:var(--bad)}
    .link{color:var(--accent);cursor:pointer}
    @media (max-width:800px){.gen-form{grid-template-columns:1fr}}
    @media print{
      header, .toolbar, .tabs, .libRow, .foot, .note.hide-print, .no-print{display:none!important}
      body{background:#fff;color:#000}
      .card, .kpi{border-color:#ddd;background:#fff}
      .grid{grid-template-columns:1fr}
      a[href]:after{content:''}
    }
  </style>
</head>
<body>
  <header>
    <h1>Boat Battery Sizer & Load Calculator</h1>
    <div class="sub">Model daily DC/AC loads, generation/charging, and battery size. Save scenarios, export CSV, or print a report.</div>
  </header>

  <main class="grid">
    <!-- SETTINGS -->
    <section class="card" aria-label="Settings">
      <h2>System & Sizing Settings</h2>
      <div class="content">
        <div class="row">
          <div class="pair">
            <label for="voltage">System voltage</label>
            <select id="voltage" class="select">
              <option value="12">12 V</option>
              <option value="24">24 V</option>
              <option value="48">48 V</option>
            </select>
          </div>
          <span class="note">Choose your DC system nominal voltage (12/24/48 V).</span>
        </div>

        <div class="row">
          <div class="pair">
            <label for="chemistry">Battery chemistry</label>
            <select id="chemistry" class="select">
              <option value="LFP">LiFePO₄</option>
              <option value="AGM">AGM / Flooded Lead-acid</option>
              <option value="GEL">Gel</option>
            </select>
          </div>
          <span class="note">Sets a sensible default usable depth-of-discharge (DoD).</span>
        </div>

        <div class="row">
          <div class="pair">
            <label for="dod">Usable DoD (%)</label>
            <input id="dod" type="number" min="10" max="99" step="1" class="number" />
          </div>
          <span class="note">Typical: LFP 85–90%, AGM 50%, Gel 50–60%.</span>
        </div>

        <div class="row">
          <div class="pair">
            <label for="reserve">Reserve margin (%)</label>
            <input id="reserve" type="number" min="0" max="100" step="1" class="number" value="20"/>
          </div>
          <span class="note">Safety headroom on top of trip energy.</span>
        </div>

        <div class="row">
          <div class="pair">
            <label for="days">Trip length (days)</label>
            <input id="days" type="number" min="1" step="1" class="number" value="2"/>
          </div>
          <span class="note">Per-day hours entered below × this many days.</span>
        </div>

        <div class="row">
          <div class="pair">
            <label for="derate">Capacity derate for temp/age (%)</label>
            <input id="derate" type="number" min="0" max="50" step="1" class="number" value="0"/>
          </div>
          <span class="note">Optional: reduce effective capacity to model cold/aging.</span>
        </div>

        <div class="row">
          <div class="pair">
            <label for="invEff">Inverter efficiency (%)</label>
            <input id="invEff" type="number" min="50" max="100" step="1" class="number" value="90"/>
          </div>
          <span class="note">Only used for AC loads.</span>
        </div>

        <div class="row">
          <div class="pair">
            <label for="invStandby">Inverter standby (W)</label>
            <input id="invStandby" type="number" min="0" step="1" class="number" value="6"/>
          </div>
          <span class="note">“On but idle” draw; uses max AC hours per mode.</span>
        </div>

        <div class="foot">Tip: Switch anchor light to LED in the library to see instant savings.</div>
      </div>
    </section>

    <!-- LOADS & GENERATION (TABS) -->
    <section class="card" aria-label="Loads and Generation">
      <h2>Energy Model</h2>
      <div class="content">
        <div class="tabs no-print" role="tablist" aria-label="Energy tabs">
          <div id="tab-loads" class="tab active" role="tab" aria-controls="pane-loads" aria-selected="true">Loads</div>
          <div id="tab-gen" class="tab" role="tab" aria-controls="pane-gen" aria-selected="false">Generation & Charging</div>
        </div>

        <div class="tabpanes">
          <!-- LOADS -->
          <div id="pane-loads" class="pane active" role="tabpanel" aria-labelledby="tab-loads">
            <div class="toolbar no-print">
              <button class="primary" id="addRow">Add Load</button>
              <select id="libSelect"></select>
              <button id="addFromLib">Add from Library</button>
              <button id="saveScenario">Save</button>
              <button id="loadScenario">Load</button>
              <button id="exportCsv">Export CSV</button>
              <button onclick="window.print()">Print Report</button>
              <button id="resetAll">Reset</button>
            </div>

            <div class="note hide-print">Columns: Name • Category • DC/AC • Entry (Watts/Amps) • Value • Hours (Anchor/Underway) • Duty % • Qty • Delete</div>

            <div style="overflow:auto">
              <table id="loadTable" aria-describedby="table of loads">
                <thead>
                  <tr>
                    <th style="min-width:220px">Name</th>
                    <th>Category</th>
                    <th>Type</th>
                    <th>Entry</th>
                    <th class="center">W/A</th>
                    <th class="center">Hours @ Anchor</th>
                    <th class="center">Hours Underway</th>
                    <th class="center">Duty %</th>
                    <th class="center">Qty</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </div>

          <!-- GENERATION (Dynamic Form by Type) -->
          <div id="pane-gen" class="pane" role="tabpanel" aria-labelledby="tab-gen">
            <div class="gen-form">
              <div class="full">
                <div class="pair">
                  <label for="gen-type">Source type</label>
                  <select id="gen-type" class="select" aria-label="Source type">
                    <option>Solar</option>
                    <option>Wind</option>
                    <option>Alternator</option>
                    <option>AC Charger</option>
                  </select>
                </div>
              </div>

              <div class="full">
                <div class="pair">
                  <label for="gen-name">Name</label>
                  <input id="gen-name" placeholder="e.g., Arch Solar Array, Wind 400W, Victron 30A, Engine Alt 40A">
                </div>
              </div>

              <!-- Type-specific fields container -->
              <div id="gen-fields" class="full"></div>

              <div>
                <div class="pair">
                  <label for="gen-hours">Hours/day</label>
                  <input id="gen-hours" type="number" min="0" step="0.1" value="4">
                </div>
                <span class="note">For Solar use sun hours; Wind often 24 h; Chargers/Alt = runtime.</span>
              </div>

              <div>
                <div class="pair">
                  <label for="gen-qty">Quantity</label>
                  <input id="gen-qty" type="number" min="1" step="1" value="1">
                </div>
                <span class="note">Number of identical sources.</span>
              </div>

              <div class="full" style="display:flex;gap:8px;align-items:center">
                <button class="primary" id="gen-add">Add Source</button>
                <button id="gen-update" style="display:none">Update</button>
                <button id="gen-cancel" style="display:none">Cancel</button>
                <span id="gen-editing" class="muted"></span>
              </div>
            </div>

            <div class="gen-list">
              <div class="note hide-print">Click a row to edit. “Wh/day” and “Ah/day” are computed at your system voltage.</div>
              <div style="overflow:auto">
                <table id="genTable">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th>Details</th>
                      <th class="center">Qty</th>
                      <th class="center">Wh/day</th>
                      <th class="center">Ah/day</th>
                      <th class="center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="genBody"></tbody>
                </table>
              </div>
            </div>

            <div class="foot">
              Solar uses (Panel W × Panels × Sun Hrs × (1−Derate%) × Controller Eff%). Wind uses (Rated W × Capacity % × Hours). Alternator uses (DC A × V × Hours). AC Charger uses (DC A × V × Hours × Eff%).
            </div>
          </div>
        </div>

        <!-- KPIs -->
        <div class="summary" style="margin-top:12px">
          <div class="kpi"><div class="label">LOADS — DC + AC (after inverter) — Wh/day</div><div id="whDay" class="value">0</div></div>
          <div class="kpi"><div class="label">LOADS — Ah/day @ <span id="vLabel">12</span> V</div><div id="ahDay" class="value">0</div></div>
          <div class="kpi"><div class="label">GEN — Wh/day</div><div id="genWhDay" class="value">0</div></div>
          <div class="kpi"><div class="label">GEN — Ah/day @ <span id="vLabel2">12</span> V</div><div id="genAhDay" class="value">0</div></div>
        </div>

        <div class="summary" style="margin-top:6px">
          <div class="kpi"><div class="label">NET (Gen − Loads) — Wh/day</div><div id="netWhDay" class="value">0</div></div>
          <div class="kpi"><div class="label">NET — Ah/day</div><div id="netAhDay" class="value">0</div></div>
          <div class="kpi"><div class="label">Trip energy — Wh / Ah (loads only)</div><div id="tripWhAh" class="value">0 / 0</div></div>
          <div class="kpi"><div class="label">Battery required — Usable / Nameplate (Ah)</div><div id="bankAh" class="value">0 / 0</div></div>
        </div>

        <div class="summary" style="margin-top:6px">
          <div class="kpi"><div class="label">Anchor — Wh / Ah per day</div><div id="anchorWhAh" class="value">0 / 0</div></div>
          <div class="kpi"><div class="label">Underway — Wh / Ah per day</div><div id="sailWhAh" class="value">0 / 0</div></div>
          <div class="kpi"><div class="label">Est. inverter standby Wh/day</div><div id="invStandbyWh" class="value">0</div></div>
          <div class="kpi"><div class="label">Suggested module layout</div><div id="suggestLayout" class="value">—</div></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Shortcuts ----------
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    // ---------- Defaults ----------
    const DEFAULTS = {
      chemistry: 'LFP',
      dodByChem: { LFP: 88, AGM: 50, GEL: 55 },
      voltage: 12,
      reserve: 20,
      days: 2,
      invEff: 90,
      invStandby: 6,
      derate: 0,
    };
    const CATS = ['Lights','Nav/Comms','Instruments','Pumps','Comfort','Galley','Entertainment','Misc'];

    // ---------- Libraries ----------
    const LIB = [
      // Lights
      libW('Anchor Light (LED)', 'Lights', 2, 8, 0, 100, 1, 'DC'),
      libW('Anchor Light (Incandescent 25 W)', 'Lights', 25, 8, 0, 100, 1, 'DC'),
      libA('Cabin Lights (LED group avg)', 'Lights', 0.6, 3, 0, 100, 1, 'DC'),
      libW('Running/Nav Lights (LED set)', 'Lights', 6, 0, 4, 100, 1, 'DC'),
      // Nav/Comms
      libA('VHF (standby avg)', 'Nav/Comms', 0.3, 0, 5, 100, 1, 'DC'),
      // Instruments
      libA('Chartplotter/MFD', 'Instruments', 1.0, 0, 5, 100, 1, 'DC'),
      libA('Depth/Wind (avg)', 'Instruments', 0.4, 0, 5, 100, 1, 'DC'),
      // Comfort
      libA('Cabin Fan', 'Comfort', 0.18, 12, 0, 100, 1, 'DC'),
      // Galley & misc
      libW('Laptop (USB-PD 65 W)', 'Misc', 65, 4, 0, 100, 1, 'DC'),
      libW('Laptop (AC 65 W via inverter)', 'Misc', 65, 4, 0, 100, 1, 'AC'),
      libW('Fridge (60 W @ 35% duty)', 'Misc', 60, 24, 0, 35, 1, 'DC'),
      libW('Microwave 900 W (10 min)', 'Galley', 900, .17, 0, 100, 1, 'AC'),
      libW('Coffee Maker 900 W (10 min)', 'Galley', 900, .17, 0, 100, 1, 'AC'),
      libA('Stereo (avg listening)', 'Entertainment', 2.0, 6, 0, 100, 1, 'DC'),
    ];
    function libW(name, cat, watts, hA, hS, duty, qty, type){
      return {name, category:cat, type:type||'DC', entry:'W', value:watts, hAnchor:hA, hSail:hS, duty, qty};
    }
    function libA(name, cat, amps, hA, hS, duty, qty, type){
      return {name, category:cat, type:type||'DC', entry:'A', value:amps, hAnchor:hA, hSail:hS, duty, qty};
    }

    // ---------- State ----------
    let state = {
      settings: {...DEFAULTS},
      rows: [],
      gen: [],      // array of {id, type, name, qty, hours, ...type fields}
      editId: null, // currently editing generation id
    };
    const newId = ()=> Math.random().toString(36).slice(2,10);

    // ---------- Settings refs ----------
    const voltage = $('#voltage');
    const chemistry = $('#chemistry');
    const dod = $('#dod');
    const reserve = $('#reserve');
    const days = $('#days');
    const invEff = $('#invEff');
    const invStandby = $('#invStandby');
    const derate = $('#derate');

    // ---------- Loads refs ----------
    const tbody = $('#tbody');
    const libSelect = $('#libSelect');

    // ---------- Generation refs ----------
    const tabLoads = $('#tab-loads');
    const tabGen = $('#tab-gen');
    const paneLoads = $('#pane-loads');
    const paneGen = $('#pane-gen');

    const genType = $('#gen-type');
    const genName = $('#gen-name');
    const genFields = $('#gen-fields');
    const genHours = $('#gen-hours');
    const genQty = $('#gen-qty');
    const genAddBtn = $('#gen-add');
    const genUpdateBtn = $('#gen-update');
    const genCancelBtn = $('#gen-cancel');
    const genEditingLabel = $('#gen-editing');
    const genBody = $('#genBody');

    // ---------- Init ----------
    voltage.value = DEFAULTS.voltage;
    chemistry.value = DEFAULTS.chemistry;
    dod.value = DEFAULTS.dodByChem[DEFAULTS.chemistry];

    chemistry.addEventListener('change', ()=>{
      if(!manualDodChange) dod.value = DEFAULTS.dodByChem[chemistry.value] || 80;
      recalc();
    });
    let manualDodChange=false;
    dod.addEventListener('input', ()=>{ manualDodChange=true; recalc(); });

    [voltage,reserve,days,invEff,invStandby,derate].forEach(el=> el.addEventListener('input', recalc));

    function refreshLib(){
      libSelect.innerHTML = LIB.map((it,i)=>`<option value="${i}">${escapeHtml(it.name)} — ${it.category}</option>`).join('');
    }
    refreshLib();

    $('#addFromLib').addEventListener('click', ()=>{
      const i = +libSelect.value; if(isNaN(i)) return;
      addRow({...LIB[i]});
    });
    $('#addRow').addEventListener('click', ()=> addRow());

    $('#exportCsv').addEventListener('click', exportCSV);
    $('#saveScenario').addEventListener('click', ()=>{
      localStorage.setItem('boatSizerScenario', JSON.stringify(state));
      toast('Scenario saved to this browser.');
    });
    $('#loadScenario').addEventListener('click', ()=>{
      const raw = localStorage.getItem('boatSizerScenario');
      if(!raw){ toast('No saved scenario found.'); return; }
      try{ const data = JSON.parse(raw); loadState(data); toast('Scenario loaded.'); }catch(e){ toast('Failed to load scenario.'); }
    });
    $('#resetAll').addEventListener('click', ()=>{
      if(confirm('Clear all rows and reset settings?')){
        state.rows=[]; tbody.innerHTML='';
        state.gen=[]; genBody.innerHTML='';
        // default loads
        ['Anchor Light (LED)','Chartplotter/MFD'].forEach(n=>{ const it = LIB.find(x=>x.name===n); if(it) addRow({...it});});
        // default generation
        setGenType('Solar');
        genName.value = 'Solar: 200 W × 2';
        $('#field-panelW').value = 200;
        $('#field-panels').value = 2;
        $('#field-sun').value = 4.5;
        $('#field-derate').value = 15;
        $('#field-ctrl').value = 96;
        genHours.value = 4.5;
        genQty.value = 1;
        onAddGen();
        // reset settings
        voltage.value=12; chemistry.value='LFP'; dod.value=DEFAULTS.dodByChem['LFP']; reserve.value=20; days.value=2; invEff.value=90; invStandby.value=6; derate.value=0;
        recalc();
      }
    });

    // Tabs behavior
    function setTab(which){
      if(which==='loads'){
        tabLoads.classList.add('active'); tabLoads.setAttribute('aria-selected','true');
        tabGen.classList.remove('active'); tabGen.setAttribute('aria-selected','false');
        paneLoads.classList.add('active'); paneGen.classList.remove('active');
      } else {
        tabGen.classList.add('active'); tabGen.setAttribute('aria-selected','true');
        tabLoads.classList.remove('active'); tabLoads.setAttribute('aria-selected','false');
        paneGen.classList.add('active'); paneLoads.classList.remove('active');
      }
    }
    tabLoads.addEventListener('click', ()=>setTab('loads'));
    tabGen.addEventListener('click', ()=>setTab('gen'));

    // ---------- Loads table ----------
    function addRow(row){
      const r = Object.assign({
        name:'New Load', category:CATS[0], type:'DC', entry:'W', value:1, hAnchor:0, hSail:0, duty:100, qty:1
      }, row||{});
      state.rows.push(r);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input aria-label="Name" value="${escapeAttr(r.name)}"/></td>
        <td>${catSelect(r.category)}</td>
        <td>
          <select aria-label="Type">
            <option value="DC" ${r.type==='DC'?'selected':''}>DC</option>
            <option value="AC" ${r.type==='AC'?'selected':''}>AC via inverter</option>
          </select>
        </td>
        <td>
          <select aria-label="Entry">
            <option value="W" ${r.entry==='W'?'selected':''}>Watts</option>
            <option value="A" ${r.entry==='A'?'selected':''}>Amps</option>
          </select>
        </td>
        <td><input type="number" step="0.01" class="number" aria-label="Value" value="${r.value}"/></td>
        <td><input type="number" step="0.1" class="number" aria-label="Hours at Anchor" value="${r.hAnchor}"/></td>
        <td><input type="number" step="0.1" class="number" aria-label="Hours Underway" value="${r.hSail}"/></td>
        <td><input type="number" step="1" class="qty" aria-label="Duty %" value="${r.duty}"/></td>
        <td><input type="number" step="1" class="qty" aria-label="Qty" value="${r.qty}"/></td>
        <td class="center"><button title="Delete" aria-label="Delete row">✕</button></td>
      `;
      tbody.appendChild(tr);
      const [iName, iCat, iType, iEntry, iVal, iHA, iHS, iDuty, iQty, iDel] = [
        tr.children[0].firstElementChild,
        tr.children[1].firstElementChild,
        tr.children[2].firstElementChild,
        tr.children[3].firstElementChild,
        tr.children[4].firstElementChild,
        tr.children[5].firstElementChild,
        tr.children[6].firstElementChild,
        tr.children[7].firstElementChild,
        tr.children[8].firstElementChild,
        tr.children[9].firstElementChild,
      ];
      const sync = ()=>{
        r.name=iName.value; r.category=iCat.value; r.type=iType.value; r.entry=iEntry.value;
        r.value=num(iVal.value); r.hAnchor=num(iHA.value); r.hSail=num(iHS.value);
        r.duty=clamp(num(iDuty.value),0,100); r.qty=Math.max(0, Math.round(num(iQty.value))||0);
        recalc();
      };
      [iName,iCat,iType,iEntry,iVal,iHA,iHS,iDuty,iQty].forEach(el=> el.addEventListener('input', sync));
      iDel.addEventListener('click', ()=>{ state.rows = state.rows.filter(x=>x!==r); tr.remove(); recalc(); });
      recalc();
    }
    function catSelect(val){
      return `<select>${CATS.map(c=>`<option ${c===val?'selected':''}>${c}</option>`).join('')}</select>`
    }

    // ---------- Generation form (dynamic) ----------
    function setGenType(type){
      genType.value = type;
      renderGenFields(type);
    }
    function renderGenFields(type){
      // Render correct labeled inputs for chosen type
      if(type==='Solar'){
        genFields.innerHTML = `
          <div class="pair"><label for="field-panelW">Panel wattage (W)</label><input id="field-panelW" type="number" min="0" step="1" value="200"></div>
          <div class="pair"><label for="field-panels"># of panels</label><input id="field-panels" type="number" min="1" step="1" value="2"></div>
          <div class="pair"><label for="field-sun">Sun hours (h/day)</label><input id="field-sun" type="number" min="0" step="0.1" value="4.5"></div>
          <div class="pair"><label for="field-derate">Derate (%)</label><input id="field-derate" type="number" min="0" max="100" step="1" value="15"></div>
          <div class="pair"><label for="field-ctrl">Controller eff (%)</label><input id="field-ctrl" type="number" min="0" max="100" step="1" value="96"></div>
        `;
        genHours.value = 4.5; // align default
      }
      if(type==='Wind'){
        genFields.innerHTML = `
          <div class="pair"><label for="field-rated">Rated power (W)</label><input id="field-rated" type="number" min="0" step="1" value="400"></div>
          <div class="pair"><label for="field-cf">Capacity factor (%)</label><input id="field-cf" type="number" min="0" max="100" step="1" value="20"></div>
        `;
        genHours.value = 24;
      }
      if(type==='Alternator'){
        genFields.innerHTML = `
          <div class="pair"><label for="field-amps">DC charge current (A)</label><input id="field-amps" type="number" min="0" step="0.1" value="40"></div>
        `;
        genHours.value = 2;
      }
      if(type==='AC Charger'){
        genFields.innerHTML = `
          <div class="pair"><label for="field-amps">DC charge current (A)</label><input id="field-amps" type="number" min="0" step="0.1" value="30"></div>
          <div class="pair"><label for="field-eff">Charging efficiency (%)</label><input id="field-eff" type="number" min="0" max="100" step="1" value="92"></div>
        `;
        genHours.value = 4;
      }
    }
    genType.addEventListener('change', ()=> renderGenFields(genType.value));

    function readGenForm(){
      const type = genType.value;
      const base = {
        id: state.editId ?? newId(),
        type, name: genName.value.trim() || type, qty: Math.max(1, Math.round(num(genQty.value)||1)),
        hours: Math.max(0, num(genHours.value)||0),
      };
      if(type==='Solar'){
        return Object.assign(base, {
          panelW: num($('#field-panelW').value),
          panels: Math.max(1, Math.round(num($('#field-panels').value)||1)),
          sunHrs: num($('#field-sun').value),
          deratePct: clamp(num($('#field-derate').value),0,100),
          ctrlEffPct: clamp(num($('#field-ctrl').value),0,100),
        });
      }
      if(type==='Wind'){
        return Object.assign(base, {
          ratedW: num($('#field-rated').value),
          capacityPct: clamp(num($('#field-cf').value),0,100),
        });
      }
      if(type==='Alternator'){
        return Object.assign(base, { dcAmps: num($('#field-amps').value) });
      }
      if(type==='AC Charger'){
        return Object.assign(base, {
          dcAmps: num($('#field-amps').value),
          effPct: clamp(num($('#field-eff').value),0,100),
        });
      }
      return base;
    }

    function onAddGen(){
      const entry = readGenForm();
      state.gen.push(entry);
      clearGenForm();
      renderGenList();
      recalc();
    }
    genAddBtn.addEventListener('click', onAddGen);

    function onUpdateGen(){
      const entry = readGenForm();
      const idx = state.gen.findIndex(x=>x.id===entry.id);
      if(idx>=0){ state.gen[idx] = entry; }
      clearGenForm();
      renderGenList();
      recalc();
    }
    genUpdateBtn.addEventListener('click', onUpdateGen);
    genCancelBtn.addEventListener('click', clearGenForm);

    function clearGenForm(){
      state.editId = null;
      genEditingLabel.textContent = '';
      genUpdateBtn.style.display = 'none';
      genCancelBtn.style.display = 'none';
      genAddBtn.style.display = 'inline-block';
      genName.value = '';
      genQty.value = 1;
      setGenType(genType.value || 'Solar');
    }

    function editGen(id){
      const e = state.gen.find(x=>x.id===id);
      if(!e) return;
      state.editId = id;
      genAddBtn.style.display = 'none';
      genUpdateBtn.style.display = 'inline-block';
      genCancelBtn.style.display = 'inline-block';
      genEditingLabel.textContent = `Editing: ${e.name}`;

      setGenType(e.type);
      genName.value = e.name;
      genHours.value = e.hours;
      genQty.value = e.qty;

      if(e.type==='Solar'){
        $('#field-panelW').value = e.panelW;
        $('#field-panels').value = e.panels;
        $('#field-sun').value = e.sunHrs;
        $('#field-derate').value = e.deratePct;
        $('#field-ctrl').value = e.ctrlEffPct;
      } else if(e.type==='Wind'){
        $('#field-rated').value = e.ratedW;
        $('#field-cf').value = e.capacityPct;
      } else if(e.type==='Alternator'){
        $('#field-amps').value = e.dcAmps;
      } else if(e.type==='AC Charger'){
        $('#field-amps').value = e.dcAmps;
        $('#field-eff').value = e.effPct;
      }
    }

    function delGen(id){
      state.gen = state.gen.filter(x=>x.id!==id);
      renderGenList();
      recalc();
    }

    function detailsText(e){
      if(e.type==='Solar') return `${e.panelW}W × ${e.panels}, ${e.sunHrs}h, −${e.deratePct}% derate, ${e.ctrlEffPct}% ctrl`;
      if(e.type==='Wind') return `${e.ratedW}W @ ${e.capacityPct}% × ${e.hours}h`;
      if(e.type==='Alternator') return `${e.dcAmps}A × ${e.hours}h`;
      if(e.type==='AC Charger') return `${e.dcAmps}A × ${e.hours}h @ ${e.effPct}%`;
      return '';
    }

    function renderGenList(){
      const v = state.settings.voltage || DEFAULTS.voltage;
      genBody.innerHTML = '';
      for(const e of state.gen){
        const wh = genEntryWh(e, v);
        const ah = wh / v;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(e.name)}</td>
          <td><span class="badge">${e.type}</span></td>
          <td>${escapeHtml(detailsText(e))}</td>
          <td class="center">${e.qty}</td>
          <td class="center">${fmt(wh)}</td>
          <td class="center">${fmt(ah)}</td>
          <td class="actions center">
            <span class="link" data-act="edit">Edit</span> &nbsp;|&nbsp;
            <span class="link danger" data-act="del">Delete</span>
          </td>
        `;
        // row click to edit
        tr.addEventListener('click', (ev)=>{
          const act = ev.target?.dataset?.act;
          if(act==='edit'){ editGen(e.id); }
          if(act==='del'){ delGen(e.id); }
        });
        genBody.appendChild(tr);
      }
    }

    // ---------- Generation math ----------
    function genEntryWh(e, v){
      const qty = e.qty || 1;
      if(e.type==='Solar'){
        const {panelW=0, panels=0, sunHrs=0, deratePct=0, ctrlEffPct=100} = e;
        return qty * (panelW * panels * sunHrs * (1 - (deratePct/100)) * (ctrlEffPct/100));
      }
      if(e.type==='Wind'){
        const {ratedW=0, capacityPct=0, hours=0} = e;
        return qty * (ratedW * (capacityPct/100) * hours);
      }
      if(e.type==='Alternator'){
        const {dcAmps=0, hours=0} = e;
        return qty * (dcAmps * v * hours);
      }
      if(e.type==='AC Charger'){
        const {dcAmps=0, hours=0, effPct=100} = e;
        return qty * (dcAmps * v * hours * (effPct/100));
      }
      return 0;
    }

    // ---------- Utils ----------
    function num(v){ const n = parseFloat(v); return isNaN(n)?0:n; }
    function clamp(x,a,b){ return Math.min(b, Math.max(a,x)); }
    function escapeHtml(s=''){return s.replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
    function escapeAttr(s=''){return escapeHtml(s).replace(/'/g,'&#39;')}
    function fmt(x){
      if(!isFinite(x)) return '0';
      if(Math.abs(x) < 10) return x.toFixed(2);
      if(Math.abs(x) < 100) return x.toFixed(1);
      return Math.round(x).toLocaleString();
    }
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg; t.style.position='fixed'; t.style.bottom='16px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
      t.style.padding='8px 12px'; t.style.background='#0c1626'; t.style.color='var(--text)'; t.style.border='1px solid var(--line)'; t.style.borderRadius='10px';
      document.body.appendChild(t); setTimeout(()=>t.remove(), 1600);
    }

    // ---------- Recalc ----------
    function recalc(){
      // settings
      state.settings = {
        voltage: +voltage.value,
        chemistry: chemistry.value,
        dod: clamp(num(dod.value),10,99),
        reserve: clamp(num(reserve.value),0,100),
        days: Math.max(1, Math.round(num(days.value)||1)),
        invEff: clamp(num(invEff.value),50,100),
        invStandby: Math.max(0, num(invStandby.value)||0),
        derate: clamp(num(derate.value),0,80),
      };
      $('#vLabel').textContent = state.settings.voltage;
      $('#vLabel2').textContent = state.settings.voltage;

      // Loads
      let anchorWh=0, sailWh=0, acAnchorHours=0, acSailHours=0;
      for(const r of state.rows){
        const duty = (r.duty||0)/100; const qty = r.qty||0;
        const whA = rowWh(r, r.hAnchor, duty, qty);
        const whS = rowWh(r, r.hSail, duty, qty);
        if(r.type==='AC'){ acAnchorHours = Math.max(acAnchorHours, r.hAnchor||0); acSailHours = Math.max(acSailHours, r.hSail||0); }
        anchorWh += whA; sailWh += whS;
      }
      const standbyWhDay = state.settings.invStandby * (acAnchorHours + acSailHours);
      const whDayTotal = anchorWh + sailWh + standbyWhDay;
      const ahDayTotal = whDayTotal / state.settings.voltage;

      // Generation
      let genWhDay = 0;
      for(const e of state.gen){ genWhDay += genEntryWh(e, state.settings.voltage); }
      const genAhDay = genWhDay / state.settings.voltage;

      // Net + trip + bank
      const netWh = genWhDay - whDayTotal;
      const netAh = genAhDay - ahDayTotal;
      const tripWh = whDayTotal * state.settings.days;
      const tripAh = ahDayTotal * state.settings.days;

      const usableDoD = state.settings.dod/100;
      const withReserveAh = tripAh * (1 + state.settings.reserve/100);
      let nameplateAh = withReserveAh / usableDoD;
      if(state.settings.derate>0){ nameplateAh = nameplateAh / (1 - state.settings.derate/100); }
      const modules100 = Math.max(1, Math.ceil(nameplateAh/100));
      const layout = `${modules100} × 100 Ah @ ${state.settings.voltage} V`;

      // KPI coloring
      const netWhEl = $('#netWhDay').closest('.kpi');
      netWhEl.classList.remove('ok','warn','bad');
      if(netWh > 0) netWhEl.classList.add('ok');
      else if(Math.abs(netWh) < 200) netWhEl.classList.add('warn');
      else netWhEl.classList.add('bad');

      // Write UI
      $('#whDay').textContent = fmt(whDayTotal);
      $('#ahDay').textContent = fmt(ahDayTotal);
      $('#genWhDay').textContent = fmt(genWhDay);
      $('#genAhDay').textContent = fmt(genAhDay);
      $('#netWhDay').textContent = fmt(netWh);
      $('#netAhDay').textContent = fmt(netAh);
      $('#tripWhAh').textContent = `${fmt(tripWh)} / ${fmt(tripAh)}`;
      $('#bankAh').textContent = `${fmt(withReserveAh)} / ${fmt(nameplateAh)}`;
      $('#anchorWhAh').textContent = `${fmt(anchorWh)} / ${fmt(anchorWh / state.settings.voltage)} Ah`;
      $('#sailWhAh').textContent = `${fmt(sailWh)} / ${fmt(sailWh / state.settings.voltage)} Ah`;
      $('#invStandbyWh').textContent = `${fmt(standbyWhDay)}`;
      $('#suggestLayout').textContent = layout;

      // autosave
      const autosave = { settings: state.settings, rows: state.rows, gen: state.gen };
      localStorage.setItem('boatSizerAutosave', JSON.stringify(autosave));

      // refresh gen list numbers (in case voltage changed)
      renderGenList();
    }

    function rowWh(r, hours, duty, qty){
      const v = state.settings.voltage; const eff = state.settings.invEff/100;
      const h = Math.max(0, hours||0) * Math.max(0, duty||0) * (qty||0);
      if(h<=0) return 0;
      if(r.type==='AC'){
        if(r.entry==='W') return (r.value||0) * h / eff;
        return (r.value||0) * 120 * h / eff;
      } else {
        if(r.entry==='W') return (r.value||0) * h;
        return (r.value||0) * v * h;
      }
    }

    // CSV Export (loads + summaries)
    function exportCSV(){
      const headers = ['Name','Category','Type','Entry','Value','Hours_Anchor','Hours_Underway','Duty_%','Qty'];
      const rows = state.rows.map(r=>[
        r.name, r.category, r.type, r.entry, r.value, r.hAnchor, r.hSail, r.duty, r.qty
      ]);
      const totals = [
        [],
        ['Summary','','','',''],
        ['Loads Wh/day', '', '', '', $('#whDay').textContent],
        ['Loads Ah/day', '', '', '', $('#ahDay').textContent],
        ['Gen Wh/day', '', '', '', $('#genWhDay').textContent],
        ['Gen Ah/day', '', '', '', $('#genAhDay').textContent],
        ['Net Wh/day', '', '', '', $('#netWhDay').textContent],
        ['Net Ah/day', '', '', '', $('#netAhDay').textContent],
        ['Trip Wh (loads)', '', '', '', $('#tripWhAh').textContent.split('/')[0].trim()],
        ['Trip Ah (loads)', '', '', '', $('#tripWhAh').textContent.split('/')[1].trim()],
        ['Usable Ah needed', '', '', '', $('#bankAh').textContent.split('/')[0].trim()],
        ['Nameplate Ah (bank)', '', '', '', $('#bankAh').textContent.split('/')[1].trim()],
      ];
      const csv = [headers, ...rows, ...totals]
        .map(r=>r.map(v=>String(v??'').replace(/"/g,'""')).map(v=>`"${v}"`).join(','))
        .join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='boat-battery-loads.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // ---------- Load autosave on start + sensible defaults ----------
    (function(){
      setGenType('Solar'); // render initial fields
      const raw = localStorage.getItem('boatSizerAutosave');
      if(raw){
        try{ loadState(JSON.parse(raw)); recalc(); return; }catch(e){}
      }
      // defaults if no autosave
      ['Anchor Light (Incandescent 25 W)','Chartplotter/MFD','Cabin Fan','Stereo (avg listening)','Laptop (USB-PD 65 W)'].forEach(n=>{
        const it = LIB.find(x=>x.name===n); if(it) addRow({...it});
      });
      genName.value = 'Solar: 200 W × 2';
      $('#field-panelW').value = 200;
      $('#field-panels').value = 2;
      $('#field-sun').value = 4.5;
      $('#field-derate').value = 15;
      $('#field-ctrl').value = 96;
      genHours.value = 4.5;
      onAddGen();
      recalc();
    })();

    function loadState(data){
      try{
        voltage.value = data.settings.voltage || 12;
        chemistry.value = data.settings.chemistry || 'LFP';
        dod.value = data.settings.dod ?? DEFAULTS.dodByChem[chemistry.value];
        reserve.value = data.settings.reserve ?? 20;
        days.value = data.settings.days ?? 2;
        invEff.value = data.settings.invEff ?? 90;
        invStandby.value = data.settings.invStandby ?? 6;
        derate.value = data.settings.derate ?? 0;

        tbody.innerHTML=''; state.rows = [];
        (data.rows||[]).forEach(r=> addRow(r));

        state.gen = [];
        genBody.innerHTML='';
        (data.gen||[]).forEach(e=>{ state.gen.push(e); });
        renderGenList();
      }catch(e){ console.error(e); }
    }
  </script>
</body>
</html>
